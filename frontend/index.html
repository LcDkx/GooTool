<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <title>è´­ç‰©å°ç¥¨OCRè¯†åˆ«å·¥å…·</title>
    <style>
        /* åŸºç¡€æ ·å¼è®¾ç½® */
        body { font-family: 'Segoe UI', system-ui, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #f5f7fa; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); }

        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-area { border: 3px dashed #ccc; border-radius: 8px; padding: 40px 20px; text-align: center; margin-bottom: 30px; transition: all 0.3s; cursor: pointer; }
        .upload-area:hover, .upload-area.dragover { border-color: #4a6cf7; background-color: #f0f4ff; }
        #fileInput { display: none; }
        .upload-label { font-size: 1.2em; color: #4a6cf7; cursor: pointer; display: block; }

        /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
        #imagePreview { text-align: center; margin: 20px 0; display: none; }
        #previewImg { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* æ§åˆ¶é¢æ¿ï¼ˆåˆ—é€‰æ‹©ä¸æŒ‰é’®ï¼‰ */
        .controls-panel { background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0; display: none; }
        .column-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .column-option { display: flex; align-items: center; }
        .column-option input { margin-right: 8px; }

        /* æŒ‰é’®æ ·å¼ */
        button { background: #4a6cf7; color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background 0.2s; }
        button:hover { background: #3a5bd9; }
        button:disabled { background: #a0a0a0; cursor: not-allowed; }
        #recognizeBtn { background: #10b981; }
        #recognizeBtn:hover { background: #0da271; }
        #recognizeBtn:disabled { background: #a0f0c7; }

        /* ç»“æœåŒºåŸŸæ ·å¼ */
        #resultArea { margin-top: 30px; display: none; }
        #loadingIndicator { text-align: center; color: #666; display: none; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4a6cf7; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* è¡¨æ ¼æ ·å¼ */
        #resultTable { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        #resultTable th, #resultTable td { border: 1px solid #e2e8f0; padding: 12px 15px; text-align: left; }
        #resultTable th { background-color: #4a6cf7; color: white; font-weight: 600; }
        #resultTable tr:nth-child(even) { background-color: #f8fafc; }
        #resultTable tr:hover { background-color: #f0f4ff; }

        /* é”™è¯¯å’Œç©ºçŠ¶æ€æç¤º */
        #errorArea, #emptyResult { padding: 15px; border-radius: 6px; text-align: center; display: none; }
        #errorArea { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        #emptyResult { background-color: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›’ è´­ç‰©å°ç¥¨OCRè¯†åˆ«ç³»ç»Ÿ</h1>
        <p>ä¸Šä¼ è´­ç‰©å°ç¥¨ã€æ”¯ä»˜æˆªå›¾ç­‰å›¾ç‰‡ï¼Œå¿«é€Ÿæå–å¹¶æ•´ç†æ¶ˆè´¹ä¿¡æ¯ã€‚</p>

        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept="image/*">
            <label for="fileInput" class="upload-label">ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡ æˆ– ç›´æ¥å°†å›¾ç‰‡æ‹–æ‹½è‡³æ­¤</label>
            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">æ”¯æŒæ ¼å¼ï¼šJPEG, PNG, WEBP (å»ºè®®å›¾ç‰‡å¤§å° < 5MB)</p>
        </div>

        <!-- å›¾ç‰‡é¢„è§ˆ -->
        <div id="imagePreview">
            <img id="previewImg" src="" alt="å›¾ç‰‡é¢„è§ˆ">
        </div>

        <!-- æ§åˆ¶é¢æ¿ï¼šåˆ—é€‰æ‹©ä¸è¯†åˆ«æŒ‰é’® -->
        <div class="controls-panel" id="controlsPanel">
            <h3>ğŸ”§ è‡ªå®šä¹‰ç»“æœè¡¨æ ¼</h3>
            <p>è¯·é€‰æ‹©æ‚¨å¸Œæœ›åœ¨ç»“æœè¡¨æ ¼ä¸­å±•ç¤ºçš„ä¿¡æ¯åˆ—ï¼š</p>
            <div class="column-selector" id="columnSelector">
                <!-- åˆ—é€‰æ‹©é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="recognizeBtn">å¼€å§‹è¯†åˆ«</button>
        </div>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div id="loadingIndicator">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠªåŠ›è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
        <div id="errorArea"></div>

        <!-- è¯†åˆ«ç»“æœåŒºåŸŸ -->
        <div id="resultArea">
            <h3>ğŸ“‹ è¯†åˆ«ç»“æœ</h3>
            <div id="emptyResult">æœªæ‰¾åˆ°å¯è¯†åˆ«çš„è¡¨æ ¼æ•°æ®ï¼Œè¯·å°è¯•è°ƒæ•´å›¾ç‰‡æˆ–é€‰æ‹©å…¶ä»–åˆ—ã€‚</div>
            <table id="resultTable">
                <thead>
                    <!-- è¡¨å¤´å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </thead>
                <tbody>
                    <!-- è¡¨æ ¼æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // åç«¯APIåŸºç¡€URL - è¯·æ ¹æ®æ‚¨çš„å®é™…éƒ¨ç½²åœ°å€ä¿®æ”¹
        const API_BASE_URL = 'http://47.92.221.246:8000/api/v1';

        // é¡µé¢å…ƒç´ å¼•ç”¨
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const controlsPanel = document.getElementById('controlsPanel');
        const columnSelector = document.getElementById('columnSelector');
        const recognizeBtn = document.getElementById('recognizeBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultArea = document.getElementById('resultArea');
        const resultTable = document.getElementById('resultTable');
        const errorArea = document.getElementById('errorArea');
        const emptyResult = document.getElementById('emptyResult');

        // å¯ç”¨çš„åˆ—é€‰é¡¹ï¼ˆè¿™äº›åº”ä¸åç«¯è¿”å›çš„æ•°æ®å­—æ®µåŒ¹é…ï¼‰
        // æ‚¨å¯ä»¥æ ¹æ®åç«¯OCRæœåŠ¡å®é™…è¿”å›çš„å­—æ®µè¿›è¡Œè°ƒæ•´
        const availableColumns = [
            { id: 'item_name', name: 'å•†å“åç§°', default: true },
            { id: 'quantity', name: 'æ•°é‡', default: true },
            { id: 'unit_price', name: 'å•ä»·', default: true },
            { id: 'total_price', name: 'æ€»ä»·', default: true },
            { id: 'category', name: 'åˆ†ç±»', default: false },
            { id: 'transaction_date', name: 'äº¤æ˜“æ—¥æœŸ', default: false },
            { id: 'store_name', name: 'å•†åº—åç§°', default: false }
        ];

        // å½“å‰é€‰ä¸­çš„åˆ—å’Œå›¾ç‰‡æ•°æ®
        let selectedColumns = availableColumns.filter(col => col.default).map(col => col.id);
        let currentImageFile = null;

        // åˆå§‹åŒ–åˆ—é€‰æ‹©å™¨
        function initializeColumnSelector() {
            columnSelector.innerHTML = '';
            availableColumns.forEach(column => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'column-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col_${column.id}`;
                checkbox.checked = selectedColumns.includes(column.id);
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        if (!selectedColumns.includes(column.id)) {
                            selectedColumns.push(column.id);
                        }
                    } else {
                        selectedColumns = selectedColumns.filter(id => id !== column.id);
                    }
                });

                const label = document.createElement('label');
                label.htmlFor = `col_${column.id}`;
                label.textContent = column.name;

                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                columnSelector.appendChild(optionDiv);
            });
        }

        // åˆå§‹åŒ–æ‹–æ”¾åŠŸèƒ½
        function initializeDragAndDrop() {
            // é˜²æ­¢æµè§ˆå™¨é»˜è®¤çš„æ‹–æ”¾è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // é«˜äº®æ˜¾ç¤ºæ‹–æ”¾åŒºåŸŸ
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            // å¤„ç†æ‹–æ”¾æ–‡ä»¶
            uploadArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                uploadArea.classList.add('dragover');
            }

            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleImageSelection(files[0]);
                }
            }
        }

        // å¤„ç†å›¾ç‰‡é€‰æ‹©ï¼ˆåŒ…æ‹¬æ–‡ä»¶è¾“å…¥å’Œæ‹–æ”¾ï¼‰
        function handleImageSelection(file) {
            // ç®€å•çš„æ–‡ä»¶ç±»å‹éªŒè¯
            if (!file.type.match('image.*')) {
                showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆJPEGã€PNGç­‰æ ¼å¼ï¼‰ã€‚');
                return;
            }

            // ç®€å•çš„æ–‡ä»¶å¤§å°éªŒè¯ï¼ˆé™åˆ¶ä¸º5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼Œè¯·é€‰æ‹©è¾ƒå°çš„å›¾ç‰‡ã€‚');
                return;
            }

            currentImageFile = file;

            // é¢„è§ˆå›¾ç‰‡
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                controlsPanel.style.display = 'block';
                resultArea.style.display = 'none';
                errorArea.style.display = 'none';

                // æ»šåŠ¨åˆ°æ§åˆ¶é¢æ¿åŒºåŸŸ
                controlsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            };
            reader.readAsDataURL(file);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            errorArea.textContent = 'é”™è¯¯: ' + message;
            errorArea.style.display = 'block';
            resultArea.style.display = 'none';
            loadingIndicator.style.display = 'none';
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            errorArea.style.display = 'none';
        }

        // æ‰§è¡ŒOCRè¯†åˆ«
        async function performOCR() {
            if (!currentImageFile) {
                showError('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            loadingIndicator.style.display = 'block';
            resultArea.style.display = 'none';
            hideError();
            recognizeBtn.disabled = true;

            try {
                // åˆ›å»ºFormDataå¯¹è±¡ï¼Œç”¨äºæ–‡ä»¶ä¸Šä¼ 
                const formData = new FormData();
                formData.append('file', currentImageFile);

                // æ„å»ºè¯·æ±‚URLï¼ŒåŒ…å«é€‰æ‹©çš„åˆ—ä½œä¸ºæŸ¥è¯¢å‚æ•°
                const columnsParam = selectedColumns.join(',');
                const url = `${API_BASE_URL}/ocr/receipt?columns=${encodeURIComponent(columnsParam)}`;

                // å‘é€è¯·æ±‚åˆ°åç«¯API
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                }

                const result = await response.json();

                // å¤„ç†è¯†åˆ«ç»“æœ
                displayResults(result);

            } catch (error) {
                console.error('OCRè¯†åˆ«å¤±è´¥:', error);
                showError(`è¯†åˆ«è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`);
            } finally {
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨ï¼Œé‡æ–°å¯ç”¨è¯†åˆ«æŒ‰é’®
                loadingIndicator.style.display = 'none';
                recognizeBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
        function displayResults(result) {
            hideError();
            emptyResult.style.display = 'none';

            let dataArray = [];
            if (Array.isArray(result.data)) {
                dataArray = result.data;  // å¦‚æœå·²ç»æ˜¯æ•°ç»„
            } else if (result.data && typeof result.data === 'object' && Array.isArray(result.data.items)) {
                dataArray = result.data.items;  // æå– items æ•°ç»„ï¼ˆåŸºäºåç«¯ç»“æ„ï¼‰
            } else if (result.data && typeof result.data === 'object') {
                // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè½¬ä¸ºå•å…ƒç´ æ•°ç»„ï¼ˆe.g., æ˜¾ç¤ºæ€»ä½“ä¿¡æ¯ï¼‰
                dataArray = [result.data];
            }

            if (dataArray.length === 0) {
                emptyResult.style.display = 'block';
                resultTable.style.display = 'none';
                resultArea.style.display = 'block';
                return;
            }

            resultArea.style.display = 'block';
            resultTable.style.display = 'table';

            resultTable.querySelector('thead').innerHTML = '';
            resultTable.querySelector('tbody').innerHTML = '';

            const headerRow = document.createElement('tr');
            selectedColumns.forEach(columnId => {
                const column = availableColumns.find(col => col.id === columnId);
                if (column) {
                    const th = document.createElement('th');
                    th.textContent = column.name;
                    headerRow.appendChild(th);
                }
            });
            resultTable.querySelector('thead').appendChild(headerRow);

            const tbody = resultTable.querySelector('tbody');
            dataArray.forEach(item => {  // ç°åœ¨ä½¿ç”¨ dataArrayï¼Œç¡®ä¿æ˜¯æ•°ç»„
                const row = document.createElement('tr');
                selectedColumns.forEach(columnId => {
                    const td = document.createElement('td');
                    td.textContent = item[columnId] || '';
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });

            resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initializeEventListeners() {
            // æ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    handleImageSelection(this.files[0]);
                }
            });

            // è¯†åˆ«æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            recognizeBtn.addEventListener('click', performOCR);

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', function(e) {
                if (e.target !== fileInput) {
                    fileInput.click();
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeColumnSelector();
            initializeDragAndDrop();
            initializeEventListeners();
        });
    </script>
</body>
</html>